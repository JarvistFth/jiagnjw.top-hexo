---
title: redis设计与实现读书笔记(5)--多机数据库
date: 2020-08-13 15:54:05
categories: redis
tags: [redis]
keywords: [redis]
---
redis多级数据库主要有三部分：1、主从模式；2、sentinel高可用解决方案；3、redis集群。

<!---more--->

# 主从模式
SLAVEOF命令，主从模式的复制功能包括同步(sync)和命令复制(propagate)。

## 同步

客户端发送slaveof命令时，从服务器会向主服务器发送sync命令完成。步骤如下：
1. 从服务器发送sync命令；
2. 收到sync的主服务器执行BGSAVE命令生成RDB文件，同时开启缓冲区记录这时候执行的写命令；
3. 当主服务器的BGSAVE执行完毕后会将生成的RDB文件发送到从服务器，从服务器接收并载入RDB文件恢复数据库状态；
4. 主服务器将缓冲区中的内容发送给从服务器，从服务器执行这些命令，将数据库状态进一步恢复与主服务器一致的状态。

## 命令传播
后续主服务器状态再次被修改时，需要将导致服务器状态发生变化的命令进行传播给从服务器，从服务器执行完命令后就与主服务器的状态一致了。

## 缺点
初次slaveof复制和断线重连后复制。断线重连后复制要重新对RDB文件中的所有键值对进行重建，但是大部分其实是不必要的。

SYNC也是一个非常耗费资源的操作，生成RDB文件需要磁盘IO；发送RDB文件需要耗费带宽流量；载入RDB时会阻塞进程。为了防止上述问题，SYNC命令应该只在初次slaveof时候进行。

新版采用PSYNC代替SYNC处理断线重连后复制。

## PSYNC
PSYNC有两种模式，一种是完整重同步，一种是部分重同步。完整重同步和SYNC同步步骤基本一致；部分重同步则是将主服务器断连期间执行的写命令发送给从服务器。

### 部分重同步
部分重同步功能的三个数据部分：

- 复制偏移量offset
- 复制积压缓冲区
- 服务器运行ID


#### 复制偏移量offset
执行复制的主服务器和从服务器都会分别维护一个offset，主服务器每次向从服务器传播N个字节的数据就会将自己的offset加N，从服务器接到N个字节数据就将自己的offset加N 。

所以如果主从服务器状态一致，offset也会相同。发现状态不一致后，就在复制积压缓冲区中恢复断线丢失的数据。

#### 复制积压缓冲区
复制积压缓冲区是一个由主服务器维护的固定长度大小的FIFO队列，默认1MB。

当主服务器进行命令传播时，除了发送命令，还会将命令写入复制积压缓冲区里，缓冲区还会为每个字节记录复制偏移量。

当服务器之间断线时，从服务器发送PSYNC给主服务器，也会将自己当前的offset一同发送。主服务器会根据offset判断是否丢失数据。

如果offset之后的数据仍然在复制积压缓冲区中，就执行部分重同步；如果offset之后的数据已经不存在与复制积压缓冲区，执行完整重同步。

所以根据实际需要调整复制积压缓冲区的大小很重要。

#### 服务器运行ID
在服务器启动时自动生成，40个随机的十六进制字符。
从服务器向主服务器进行初次复制时，主服务器会将自己的运行ID传送给从服务器保存。当从服务器断线并重新连上主服务器，会向主服务器发送之前保存的运行ID。如果ID相同，可以尝试进行部分重同步；否则进行完整重同步。

## PSYNC实现


# sentinel模式

# redis cluster