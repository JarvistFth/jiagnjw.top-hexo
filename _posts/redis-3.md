---
title: redis设计与实现读书笔记(3)--事件模型
date: 2020-08-03 19:33:01
categories: redis
tags: [redis]
keywords: [redis]
---

redis系列第三篇，事件模型。
<!---more--->

## 事件
redis是一个事件驱动模型，事件分为两类，一类是文件事件，一类是时间事件。

redis是经典的reactor模型，通过IO多路复用同时监听多个套接字。

reactor模式：
![](https://jaroffertree.oss-cn-hongkong.aliyuncs.com/20200803234314.png)

几个关键组件：
1. 事件源：一个事件源对应一个句柄，linux下是文件描述符。
2. 事件多路分发器：IO复用系统调用，select、poll、epoll、kqueue等。
3. 事件处理器：不同的事件在接收到事件源对应的信号时，具体的执行逻辑。
4. reactor核心：主要进行事件循环，依次处理就绪事件的事件处理器；另外可以在核心中注册或删除不同的事件处理器。

在redis中，事件源就是文件事件和时间事件，事件多路分发器就是系统多路复用函数的包装库，ae_select.c/ae_epoll.c/ae_kqueue.c。

事件处理器下面会谈到。

reactor核心这里比较淡化，主要在main函数里面执行事件循环，因为只涉及到两种事件。


### 文件事件
#### 连接应答处理器
acceptTcpHandler()是连接应答处理器的逻辑，主要负责监听服务器套接字的客户端连接，当有连接来时，事件是readable的，这时候就会执行相应的操作


#### 命令请求处理器
readQueryFromClient()是命令请求处理器的逻辑，主要是负责监听从客户端输入的文件描述符，当这个文件描述符readable的时候，就执行相应操作。

#### 命令回复处理器
sendReplyToClient()是命令回复处理器的逻辑，主要是命令执行完以后，会产生客户端交互文件描述符的writable事件。当writable时，就执行对应的逻辑。

### 时间事件

redis的时间事件分为定时事件和周期性事件。
其实就是一个定时器的实现，

#### 实现
事件是一个time_event结构，保存在一个无序链表中。运行时，遍历整个链表找到已到达的时间事件，调用它的事件处理器（回调函数）。

时间事件结构如下：
![](https://jaroffertree.oss-cn-hongkong.aliyuncs.com/20200805121630.png)

aeTimeProc就是一个回调函数，作为时间事件处理器。

redis在3.0版本中只使用一个serverCron一个事件，没有其他事件；benchmark下也只有两个时间事件。

和我写的webserver不一样，webserver支持注册多个定时器，因此如果还是用链表来存储，会存在性能问题（每次遍历都要花O(n))时间。因此webserver里面是用map实现的，查找只需O(logN)但是空间开销较大；还有一种做法是用小根堆去做，这时候注意C++小根堆是没有提供删除堆元素的操作，需要自己实现。

但是由于redis只有1-2个时间事件，因此可以用链表保存。

#### 处理过程
1. 遍历服务器中的所有时间事件
2. 检查事件是否已经到达（对比when属性和unix时间）
3. 事件到达？执行事件处理器：继续循环。
4. 执行事件，是周期事件？更新when属性：从链表中删除定时事件。

#### 实例：serverCron函数
主要工作包括：
- 更新服务器各类信息，包括时间、内存占用、数据库占用等情况；
- 清理数据库中过期的键值对；
- 关闭和清理连接失效的客户端；
- RDB和AOF持久化；
- 如果服务器是主服务器，就对从服务器进行定期同步；
- 如果处于集群模式，就对集群进行定期同步和连接测试。

