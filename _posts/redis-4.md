---
title: redis设计与实现读书笔记(4)--客户端与服务器
date: 2020-08-05 19:38:31
categories: redis
tags: [redis]
keywords: [redis]
---
redis系列第4篇，客户端服务器。
<!---more--->

## 客户端
redis的client数据结构保存了客户端的当前状态信息。举个例子：
- clientfd：客户端的套接字描述符，伪客户端（AOF文件，lua脚本）值为-1.
- name：名字
- flag：标志：客户端角色和当前状态。
- 正在使用的数据库指针、数据库号码
- 输入缓冲区和输出缓冲区：保存客户端发送的命令请求（sds）。
    - 输入缓冲区会根据内容动态调整，但不得超过1g。
    - 输出缓冲区有两个，一个固定大小一个不固定。固定缓冲区回复长度较小的回复；动态缓冲区用于回复较长的对象，用链表连接多个字符串对象实现。
- 命令与命令参数：argv：命令字符串对象；argc：参数个数
- ……

redisServer以链表的形式保存了当前所有与server进行连接的客户端。

------

### 命令实现：
服务器从传入的命令内容中分析得到argv和argc，然后根据argv查找命令字典中的值（RedisCommand结构）。

然后redisServer将对应的client的redisCommand结构设置为上述查找的结果值，该结构封装了对应的命令实现函数。

## 服务端

### 读取命令
1. 对客户端套接字中传来的格式化的字符串保存到对应的客户端输入缓冲区中；
2. 对命令请求进行解析，提取命令参数和命令参数个数，将其保存到client的argv和argc属性中。
3. 调用命令执行器，执行指令。

### 查找命令实现：
命令以表的形式存储，键是命令名字，值是redisComand结构。解析完后client的cmd会指向对应的redisCommand结构。

![](https://jaroffertree.oss-cn-hongkong.aliyuncs.com/20200806124512.png)

其中redisCommandProc就是函数指针，指向具体命令的实现函数。

### 命令执行过程

1. 命令执行准备操作：主要检查一些状态和属性，比如检查cmd属性是否为空，检查arity属性看参数个数是否符合等。
2. 调用redisCommand的proc函数指针，执行命令对应函数。
3. 执行后续操作：比如：
    - 添加慢查询日志；
    - 更新命令执行耗时(milliseconds)和计数器(calls)。
    - AOF持久化时将命令写入AOF文件；
    - 如果是主服务器，将刚才执行的命令传播给从服务器。

4. 将命令回复保存到对应客户端的输出缓冲区。

## serverCron函数
Redis中serverCron()每100毫秒执行一次，负责管理服务器的资源。

1. 更新服务器时间缓存：redis中经常需要获取系统时间，但是获取系统时间需要一次系统调用，为了减少使用系统调用的次数，redisServer中结构有unixtime 和 mstime 两个精度的属性保存unix时间戳。
<br>这些保存的时间戳并不准确（100s保存一次），所以一般只用于打印日志、LRU始终、持久化任务这些时间精确度要求不高的功能上。
<br>像过期键、慢查询日志这些会执行系统调用获取时间。

2. 更新LRU时钟
redisServer对象保存了lruclock属性，维护了服务端的lru时钟。每个redis对象都有lru属性。通过lruclock和lru属性，可以计算出赌赢的redis对象的空转时间，用于释放对应的内存。
3. 更新服务器每秒执行命令次数
4. 更新服务器内存峰值记录
5. 处理SIGTERM信号，接到这个信号的时候关闭服务器
6. 管理客户端资源，检查客户端与服务器之间的连接是不是已经超时；检查客户端缓冲区如果超过一定大小，就释放该缓冲区并重新创建一个默认大小的缓冲区。
7. 管理数据库资源，调用databasesCron函数，对数据库进行检查，删除过期键、对字典进行收缩等。
8. 在BGSAVE过程中，客户端发送BGWRITEAOF，会将BGREWRITEAOF延后执行；执行完BGSAVE后，就会执行BGREWRITEAOF。
9. 检查持久化操作的运行状态。检查子进程发来的信号，判断RDB文件是否生成完毕。如果没有持久化操作，又有BGWRITEAOF被延迟，就执行BGWRITEAOF；否则的话判断自动保存的条件是否满足，如果满足执行BGSAVE，否则判断AOF重写条件是否满足，满足则执行BGWRITEAOF。
10. 将AOF缓冲区内容写入AOF文件。
11. 关闭超出缓冲区大小限制的客户端。
12. 增加redisServer结构中，cronloops计数器的值。
