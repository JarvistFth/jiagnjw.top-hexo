---
title: redis设计与实现读书笔记(9)--redis事务
date: 2020-09-16 15:25:06
categories: redis
tags: [redis]
keywords: [redis]
---
redis的事务是怎么实现的呢？完全符合事务的原子性、一致性、隔离性、持久性吗？

<!---more--->

### REDIS事务概述
REDIS的事务通过多个命令来一起实现，包括MULTI\EXEC\WATCH等命令，将多个命令进行打包、然后一次性地按照顺序地执行多个命令。事务执行期间，也不会中断去执行其他客户端的命令请求。

事务以MULTI命令开始，然后输入普通REDIS命令，以EXEC命令结束，提交事务。

### REDIS事务的实现
经历三个阶段:
1. 事务开始；
2. 命令入队；
3. 事务执行。

#### 事务开始
MULTI命令标志事务开始，在client的flags属性中添加 REDIS_MULTI标识。

#### 命令入队
如果命令是EXEC/DISCARD/WATCH/MULTI四个命令，会立即执行；
其他命令放入事务队列中。

#### 事务队列
![](https://jaroffertree.oss-cn-hongkong.aliyuncs.com/20200917160745.png)

每个客户端有自己的事务状态（multiState结构），每个multiState里面有个multiCmd属性和一个命令计数器，multiCmd事务队列，用来存放命令。

multiCmd里面保存了入队命令的详细信息，包括指向命令实现函数的函数指针，命令参数、参数个数等。

#### 执行事务
当客户端输入EXEC时，会遍历整个事务队列，执行完毕后依次执行命令并返回执行结果。

##WATCH命令
WATCH命令是一个乐观锁，它在EXEC命令钱，监视任意多个数据库的键，然后在EXEC执行时，检查被监视的键是否被修改过；如果修改过，就拒绝执行事务，返回空错误。

#### 监视数据库键
每个redisDB都保存一个watched_keys字典，字典的键是被监视的键，值是一个链表，链表记录了所以监视对应键的客户端。
![](https://jaroffertree.oss-cn-hongkong.aliyuncs.com/20200918171230.png)

#### 监视机制的触发
对数据库进行修改的命令，执行后都会调用touchWatchKey函数对watch_keys字典进行检查，看看是否客户端正在监视刚刚修改过的key。如果有的话，将client的REDIS_DIRTY_CAS标识打开。

#### 判断事务是否安全
当收到EXEC命令时，会查看对应的client的flag是否包括REDIS_DIRTY_CAS标识。如果包括，就拒绝执行。

##REDIS的事务ACID性质
事务总是具有A（atomic 原子性）、C（consistency 一致性）、I（isolation 隔离性）、D（durability 持久性）。

#### 原子性
REDIS中的事务在一个事务队列中，要么都执行、要么都不执行。具有原子性。

REDIS包括入队错误和执行错误，入队错误时所有命令都不执行，执行错误时仍然会执行事务的后续命令。

但是REDIS并不支持事务的回滚，所以如果事务队列中某个事务执行发生了错误，事务也会继续执行下去。直到事务队列所有命令都执行完了为止。

* 作者认为回滚的功能比较复杂，与REDIS的设计主旨不符合；并且REDIS事务的执行错误都是编程错误产生，不会出现在生产环境中。

#### 一致性
数据库执行事务之前是一致的，无论执行是否成功，执行后也是一致的。

一致性要求数据符合数据库的定义和设计，没有包含非法或无效的数据。
REDIS通过错误检测来检测REDIS事务执行过程中可能出错的地方，然后处理这些错误，确保事务一致性的。

1. 入队错误：如果一个事务在入队命令中出现了命令不存在或者命令格式不正确等情况，REDIS将拒绝执行这个事务。因此一致性也不会有影响。

2. 执行错误：事务的执行错误不会再入队中识别出来，只会在实际执行的才会发现；事务中一个命令执行发生了错误，也不会影响事务后面的命令的执行。<br>在事务的过程中，命令执行的错误会被redis识别出来，向client返回error，不会对数据库进行修改，所以不会对事务的一致性产生任何影响。

3. 服务器停机，如果在内存数据库模式下， 停机重启会变成空白数据库，数据肯定一致的；<br>如果运行在RDB模式下，停机重启会使用RDB文件还原到原来的一个一致的状态；如果没有RDB文件，会恢复成空白状态，因此一致性成立。<br>AOF模式下，服务器会根据AOF文件来逐步恢复数据，恢复成一个之前一致的状态；同样的如果没有AOF文件，那么空白数据库也总是一致的。

#### 隔离性
隔离性是指多个事务并发执行，事务之前不会互相影响，多个事务并发执行与事务串行执行产生的结果也完全相同。

REDIS是以单线程的方式来执行事务，并且服务器保证在事务执行期间不会对事务进行中断；所以REDIS中的事务是串行的，因此事务也都具有隔离性。

#### 持久性
持久性是指当一个事务执行完毕时，执行事务的结果会保存到非易失性存储中，即使事务执行完毕后停机，也不会造成执行结果的丢失。

REDIS是内存数据库，对数据的持久化有RDB和AOF两种方式。
1. 当REDIS在RDB模式下时，服务器只有在特定的保存条件下才会执行BGSAVE命令，并且BGSAVE是异步操作，也不能保证结果第一时间保存到硬盘中；因此RDB模式下事务不具有持久性。RDB模式下可以在每次执行一个命令后执行以下SAVE命令，这种做法保证了持久性，但是效率太低，实际情况下不怎么使用。

2. AOF模式下，当appendfsync选项的值为always时，每次执行命令后都会调用sync函数，将命令保存到AOF文件中，所以具有持久性。<br>当appednfsync为其他选项时，都不能保证每执行完一个命令都将命令保存到AOF文件中，因此不具有持久性。
